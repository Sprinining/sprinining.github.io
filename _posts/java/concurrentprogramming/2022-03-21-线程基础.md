---
title: çº¿ç¨‹åŸºç¡€
date: 2022-03-21 03:35:24 +0800
categories: [java, concurrent programming]
tags: [Java, Concurrent Programming, Thread]
description: 
---
## çº¿ç¨‹åœæ­¢

```java
// å»ºè®®çº¿ç¨‹æ­£å¸¸åœæ­¢ï¼Œåˆ©ç”¨æ¬¡æ•°ï¼Œä¸å»ºè®®æ­»å¾ªç¯
// å»ºè®®ä½¿ç”¨æ ‡å¿—ä½
// ä¸è¦ä½¿ç”¨stopæˆ–destoryç­‰jdkä¸å»ºè®®ä½¿ç”¨çš„æ–¹æ³•
public class MyStop implements Runnable{
    private boolean flag = true;

    @Override
    public void run() {
        int i = 0;
        while (flag){
            System.out.println("run..." + i++);
        }
    }

    // è®¾ç½®ä¸€ä¸ªå…¬å¼€çš„æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼Œè½¬æ¢æ ‡å¿—ä½
    public void stop(){
        this.flag = false;
    }

    public static void main(String[] args) {
        MyStop myStop = new MyStop();
        new Thread(myStop).start();

        for (int i = 0; i < 1000; i++) {
            System.out.println("main" + i);
            if(i == 900){
                //è½¬æ¢æ ‡å¿—ä½åœæ­¢çº¿ç¨‹
                myStop.stop();
            }
        }
    }
}
```

## çº¿ç¨‹ä¼‘çœ sleep
  - sleep(æ—¶é—´)æŒ‡å®šå½“å‰çº¿ç¨‹é˜»å¡æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  - sleepå­˜åœ¨å¼‚å¸¸InterruptedException
  - sleepç»“æŸåçº¿ç¨‹è¿›å…¥å°±ç»ªæ€
  - å¯ä»¥æ¨¡æ‹Ÿç½‘ç»œå»¶æ—¶å’Œå€’è®¡æ—¶
  - æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªé”ï¼Œsleepä¸ä¼šé‡Šæ”¾é”

```java
import java.text.SimpleDateFormat;
import java.util.Date;

public class MySleep {

    public static void main(String[] args) {
        //å€’è®¡æ—¶
        try {
            tenDown();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        //æ‰“å°å½“å‰æ—¶é—´
        Date starttime = new Date(System.currentTimeMillis());
        while (true){
            try {
                Thread.sleep(1000);
                System.out.println(new SimpleDateFormat("HH:mm:ss").format(starttime));
                starttime = new Date(System.currentTimeMillis());
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }

    public static void tenDown() throws InterruptedException{
        int num = 10;
        while (true){
            Thread.sleep(1000);
            System.out.println(num--);
            if(num<=0){
                break;
            }
        }
    }
}
```

## çº¿ç¨‹ç¤¼è®©yield

  - ç¤¼è®©çº¿ç¨‹ï¼Œè®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœï¼Œä½†ä¸é˜»å¡
  - å°†çº¿ç¨‹ä»è¿è¡Œæ€è½¬ä¸ºå°±ç»ªæ€
  - è®©cpuè°ƒåº¦ï¼Œç¤¼è®©ä¸ä¸€å®šæˆåŠŸ

```java
public class MyYield implements Runnable{
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + "start");
        Thread.yield();
        System.out.println(Thread.currentThread().getName() + "stop");
    }

    public static void main(String[] args) {
        MyYield myYield = new MyYield();
        new Thread(myYield, "a").start();
        new Thread(myYield, "b").start();
    }
    /* aç¤¼è®©æˆåŠŸçš„æƒ…å†µ
    astart
    bstart
    astop
    bstop
        ä¸ç”¨yieldçš„æƒ…å†µ
    astart
    astop
    bstart
    bstop
     */
}
```

## çº¿ç¨‹å¼ºåˆ¶æ‰§è¡Œjoin

### æºç è§£æ

#### ä¸‰ç§æ„é€ å‡½æ•°

```java
void join():å½“å‰çº¿ç¨‹ç­‰è¯¥åŠ å…¥è¯¥çº¿ç¨‹åé¢ï¼Œç­‰å¾…è¯¥çº¿ç¨‹ç»ˆæ­¢ã€‚
void join(long millis):å½“å‰çº¿ç¨‹ç­‰å¾…è¯¥çº¿ç¨‹ç»ˆæ­¢çš„æ—¶é—´æœ€é•¿ä¸º millis æ¯«ç§’ã€‚ å¦‚æœåœ¨millisæ—¶é—´å†…ï¼Œè¯¥çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œé‡æ–°ç­‰å¾…cpuè°ƒåº¦ã€‚
void join(long millis,int nanos):ç­‰å¾…è¯¥çº¿ç¨‹ç»ˆæ­¢çš„æ—¶é—´æœ€é•¿ä¸º millis æ¯«ç§’ + nanosçº³ç§’ã€‚å¦‚æœåœ¨millisæ—¶é—´å†…ï¼Œè¯¥çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œé‡æ–°ç­‰å¾…cpuè°ƒåº¦ã€‚
```

#### æºç 

```java
// å½“å‰çº¿ç¨‹ç­‰å¾…è¯¥çº¿ç¨‹ç»ˆæ­¢çš„æ—¶é—´æœ€é•¿ä¸º millis æ¯«ç§’ã€‚ 
public final synchronized void join(final long millis)
throws InterruptedException {
    if (millis > 0) {
        // å¦‚æœåœ¨millisæ—¶é—´å†…ï¼Œè¯¥çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œé‡æ–°ç­‰å¾…cpuè°ƒåº¦ã€‚
        if (isAlive()) {
            final long startTime = System.nanoTime();
            long delay = millis;
            do {
                wait(delay);
            } while (isAlive() && (delay = millis -
                    TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime)) > 0);
        }
    } else if (millis == 0) {
        // join()å®é™…è°ƒç”¨çš„å°±æ˜¯join(0)
        // å¦‚æœå­çº¿ç¨‹ä¸€ç›´å­˜æ´»ï¼Œå°±ç­‰åˆ°å­çº¿ç¨‹æ‰§è¡Œç»“æŸ
        while (isAlive()) {
            wait(0);
        }
    } else {
        throw new IllegalArgumentException("timeout value is negative");
    }
}
```

- å½“mainä¸»çº¿ç¨‹è°ƒç”¨threadA.join()æ—¶ï¼Œmainçº¿ç¨‹ä¼šè·å¾—threadAçº¿ç¨‹å¯¹è±¡é”ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½æ‰§è¡Œsynchronized join()æ–¹æ³•å†…ï¼Œè°ƒç”¨threadAçº¿ç¨‹å¯¹è±¡çš„wait()ã€‚ç›®çš„æ˜¯è®©æŒæœ‰è¿™ä¸ªthreadAçº¿ç¨‹å¯¹è±¡é”çš„çº¿ç¨‹éƒ½è¿›å…¥ç­‰å¾…ï¼Œç­‰å¾…threadAçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚ç„¶åJVMåº•å±‚lock.notify_all(thread)ï¼Œå”¤é†’æŒæœ‰threadAå¯¹è±¡é”çš„æ‰€æœ‰çº¿ç¨‹ã€‚

### ä½¿ç”¨


```java
public class MyJoin implements Runnable{
    @Override
    public void run() {
        for (int i = 0; i < 1000; i++) {
            System.out.println("vip comeing" + i);
        }
    }

    public static void main(String[] args) throws InterruptedException{
        MyJoin myJoin = new MyJoin();
        Thread thread = new Thread(myJoin);
        thread.start();

        for (int i = 0; i < 500; i++) {
            if(i==200){
                thread.join();//æ’é˜Ÿ
            }
            System.out.println("main" + i);
        }
    }
}
```

## çŠ¶æ€

-  åˆå§‹çŠ¶æ€(NEW)

å®ç°Runnableæ¥å£å’Œç»§æ‰¿Threadå¯ä»¥å¾—åˆ°ä¸€ä¸ªçº¿ç¨‹ç±»ï¼Œnewä¸€ä¸ªå®ä¾‹å‡ºæ¥ï¼Œçº¿ç¨‹å°±è¿›å…¥äº†åˆå§‹çŠ¶æ€ã€‚

- å°±ç»ªçŠ¶æ€(READY)
  - å°±ç»ªçŠ¶æ€åªæ˜¯è¯´ä½ èµ„æ ¼è¿è¡Œï¼Œè°ƒåº¦ç¨‹åºæ²¡æœ‰æŒ‘é€‰åˆ°ä½ ï¼Œä½ å°±æ°¸è¿œæ˜¯å°±ç»ªçŠ¶æ€ã€‚
  - è°ƒç”¨çº¿ç¨‹çš„start()æ–¹æ³•ï¼Œæ­¤çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚
  - å½“å‰çº¿ç¨‹==sleep()æ–¹æ³•ç»“æŸ==ã€å…¶ä»–çº¿ç¨‹join()ç»“æŸã€ç­‰å¾…ç”¨æˆ·è¾“å…¥å®Œæ¯•ã€æŸä¸ªçº¿ç¨‹æ‹¿åˆ°å¯¹è±¡é”ï¼Œè¿™äº›çº¿ç¨‹ä¹Ÿå°†è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚
  - å½“å‰çº¿ç¨‹æ—¶é—´ç‰‡ç”¨å®Œäº†ï¼Œè°ƒç”¨å½“å‰çº¿ç¨‹çš„yield()æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚
  - é”æ± é‡Œçš„çº¿ç¨‹æ‹¿åˆ°å¯¹è±¡é”åï¼Œè¿›å…¥å°±ç»ªçŠ¶æ€ã€‚

- è¿è¡Œä¸­çŠ¶æ€(RUNNING)

çº¿ç¨‹è°ƒåº¦ç¨‹åºä»å¯è¿è¡Œæ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ä½œä¸ºå½“å‰çº¿ç¨‹æ—¶çº¿ç¨‹æ‰€å¤„çš„çŠ¶æ€ã€‚è¿™ä¹Ÿæ˜¯çº¿ç¨‹è¿›å…¥è¿è¡ŒçŠ¶æ€çš„å”¯ä¸€çš„ä¸€ç§æ–¹å¼ã€‚

- é˜»å¡çŠ¶æ€(BLOCKED)

é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹é˜»å¡åœ¨è¿›å…¥synchronizedå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—==(è·å–é”)==æ—¶çš„çŠ¶æ€ã€‚

-  ç­‰å¾…(WAITING)

å¤„äºè¿™ç§çŠ¶æ€çš„çº¿ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œå®ƒä»¬è¦ç­‰å¾…è¢«æ˜¾å¼åœ°å”¤é†’ï¼Œå¦åˆ™ä¼šå¤„äºæ— é™æœŸç­‰å¾…çš„çŠ¶æ€ã€‚

- è¶…æ—¶ç­‰å¾…(TIMED_WAITING)

å¤„äºè¿™ç§çŠ¶æ€çš„çº¿ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œä¸è¿‡æ— é¡»æ— é™æœŸç­‰å¾…è¢«å…¶ä»–çº¿ç¨‹æ˜¾ç¤ºåœ°å”¤é†’ï¼Œåœ¨è¾¾åˆ°ä¸€å®šæ—¶é—´åå®ƒä»¬ä¼šè‡ªåŠ¨å”¤é†’ã€‚

- ç»ˆæ­¢çŠ¶æ€(TERMINATED)
  - å½“çº¿ç¨‹çš„run()æ–¹æ³•å®Œæˆæ—¶ï¼Œæˆ–è€…ä¸»çº¿ç¨‹çš„main()æ–¹æ³•å®Œæˆæ—¶ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºå®ƒç»ˆæ­¢äº†ã€‚è¿™ä¸ªçº¿ç¨‹å¯¹è±¡ä¹Ÿè®¸æ˜¯æ´»çš„ï¼Œä½†æ˜¯å®ƒå·²ç»ä¸æ˜¯ä¸€ä¸ªå•ç‹¬æ‰§è¡Œçš„çº¿ç¨‹ã€‚çº¿ç¨‹ä¸€æ—¦ç»ˆæ­¢äº†ï¼Œå°±ä¸èƒ½å¤ç”Ÿã€‚
  - åœ¨ä¸€ä¸ªç»ˆæ­¢çš„çº¿ç¨‹ä¸Šè°ƒç”¨start()æ–¹æ³•ï¼Œä¼šæŠ›å‡ºjava.lang.IllegalThreadStateExceptionå¼‚å¸¸ã€‚

![20181120173640764](/assets/media/pictures/java/çº¿ç¨‹åŸºç¡€.assets/20181120173640764.jpeg)

```java
public class MyState {

    public static void main(String[] args) throws InterruptedException{
        Thread thread = new Thread(()->{
            for (int i = 0; i < 2; i++) {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            System.out.println("hhhhhhh");
        });

        //è§‚å¯ŸçŠ¶æ€
        Thread.State state = thread.getState();
        System.out.println(state);//new

        thread.start();
        state = thread.getState();
        System.out.println(state);//run

        while (state != Thread.State.TERMINATED){
            Thread.sleep(100);
            state = thread.getState();
            System.out.println(state);
        }
        
//        thread.start();æ­»äº¡çš„çº¿ç¨‹æ— æ³•å†æ¬¡å¯åŠ¨
    }
    
    /*
NEW
RUNNABLE
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
TIMED_WAITING
hhhhhhh
TERMINATED
     */
}
```

## çº¿ç¨‹ä¼˜å…ˆçº§
  - èŒƒå›´1~10
  - Thread.MIN_PRIORITY = 1
  - Thread.NORMAL_PRIORITY = 5
  - Thread.MAX_PRIORITY = 10
  - getPriority(),setPriority(int xxx)

```java
import java.util.SortedMap;

public class MyPriority implements Runnable{
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + "  " + Thread.currentThread().getPriority());
    }
}

class TestPriority{
    public static void main(String[] args) {
        System.out.println(Thread.currentThread().getName() + "  " + Thread.currentThread().getPriority());
        MyPriority myPriority = new MyPriority();

        Thread thread1 = new Thread(myPriority);
        Thread thread2 = new Thread(myPriority);
        Thread thread3 = new Thread(myPriority);
        Thread thread4 = new Thread(myPriority);
        Thread thread5 = new Thread(myPriority);

        //å…ˆè®¾ç½®ä¼˜å…ˆçº§å†å¯åŠ¨
        thread1.start();

        thread2.setPriority(1);
        thread2.start();

        thread3.setPriority(4);
        thread3.start();

        thread4.setPriority(10);
        thread4.start();

        thread5.setPriority(111);
        thread5.start();


    }
}
```

## å®ˆæŠ¤çº¿ç¨‹daemon
  - jvmå¿…é¡»ç¡®ä¿ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œä¸éœ€ç­‰å¾…å®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚
  - æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œè™šæ‹Ÿæœºé€€å‡ºã€‚
  - å®ˆæŠ¤çº¿ç¨‹ä¸èƒ½æŒæœ‰ä»»ä½•éœ€è¦å…³é—­çš„èµ„æºï¼Œä¾‹å¦‚æ‰“å¼€æ–‡ä»¶ç­‰ï¼Œå› ä¸ºè™šæ‹Ÿæœºé€€å‡ºæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹æ²¡æœ‰ä»»ä½•æœºä¼šæ¥å…³é—­æ–‡ä»¶ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

```java
public class MyDaemon {

    public static void main(String[] args) {
        God god = new God();
        You you = new You();

        Thread thread = new Thread(god);
        thread.setDaemon(true);// æ”¹ä¸ºå®ˆæŠ¤çº¿ç¨‹

        thread.start();// å®ˆæŠ¤çº¿ç¨‹å¼€å§‹

        new Thread(you).start();
    }
}

class You implements Runnable{
    @Override
    public void run() {
        for (int i = 0; i < 365; i++) {
            System.out.println("å¼€å¿ƒçš„æ´»ç€");
        }
        System.out.println("bye world");
    }
}

class God implements Runnable{

    @Override
    public void run() {
        while (true){
            System.out.println("God bless you");
        }
    }
}
```

## çº¿ç¨‹åŒæ­¥

- è°ƒç”¨objçš„wait(), notify()æ–¹æ³•å‰ï¼Œå¿…é¡»è·å¾—objé”ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»å†™åœ¨synchronized(obj) ä»£ç æ®µå†…ã€‚
- ä¸€ä¸ªå¯¹è±¡å¯¹åº”ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ã€‚
- çº¿ç¨‹ç­‰å¾…æ—¶é—´åˆ°äº†æˆ–è¢«notify/notifyAllå”¤é†’åï¼Œä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç«äº‰é”ï¼Œå¦‚æœè·å¾—é”ï¼Œè¿›å…¥RUNNABLEçŠ¶æ€ï¼Œå¦åˆ™è¿›å…¥BLOCKEDçŠ¶æ€ç­‰å¾…è·å–é”ã€‚
- ![20180701221233161](/assets/media/pictures/java/çº¿ç¨‹åŸºç¡€.assets/20180701221233161.jpg)
- Thread.sleep(long millis)ï¼Œä¸€å®šæ˜¯å½“å‰çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥TIMED_WAITINGçŠ¶æ€ï¼Œä½†==ä¸é‡Šæ”¾å¯¹è±¡é”==ï¼Œmillisåçº¿ç¨‹è‡ªåŠ¨è‹é†’è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚ä½œç”¨ï¼šç»™å…¶å®ƒçº¿ç¨‹æ‰§è¡Œæœºä¼šçš„æœ€ä½³æ–¹å¼ã€‚
- Thread.yield()ï¼Œä¸€å®šæ˜¯å½“å‰çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ”¾å¼ƒè·å–çš„CPUæ—¶é—´ç‰‡ï¼Œä½†==ä¸é‡Šæ”¾é”èµ„æº==ï¼Œç”±è¿è¡ŒçŠ¶æ€å˜ä¸ºå°±ç»ªçŠ¶æ€ï¼Œè®©OSå†æ¬¡é€‰æ‹©çº¿ç¨‹ã€‚ä½œç”¨ï¼šè®©ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹è½®æµæ‰§è¡Œï¼Œä½†å¹¶ä¸ä¿è¯ä¸€å®šä¼šè½®æµæ‰§è¡Œã€‚å®é™…ä¸­æ— æ³•ä¿è¯yield()è¾¾åˆ°è®©æ­¥ç›®çš„ï¼Œå› ä¸ºè®©æ­¥çš„çº¿ç¨‹è¿˜æœ‰å¯èƒ½è¢«çº¿ç¨‹è°ƒåº¦ç¨‹åºå†æ¬¡é€‰ä¸­ã€‚Thread.yield()==ä¸ä¼šå¯¼è‡´é˜»å¡==ã€‚è¯¥æ–¹æ³•ä¸sleep()ç±»ä¼¼ï¼Œåªæ˜¯ä¸èƒ½ç”±ç”¨æˆ·æŒ‡å®šæš‚åœå¤šé•¿æ—¶é—´ã€‚
- thread.join()/thread.join(long millis)ï¼Œå½“å‰çº¿ç¨‹é‡Œè°ƒç”¨å…¶å®ƒçº¿ç¨‹tçš„joinæ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥WAITING/TIMED_WAITINGçŠ¶æ€ï¼Œ==å½“å‰çº¿ç¨‹ä¸ä¼šé‡Šæ”¾å·²ç»æŒæœ‰çš„å¯¹è±¡é”==ã€‚çº¿ç¨‹tæ‰§è¡Œå®Œæ¯•æˆ–è€…millisæ—¶é—´åˆ°ï¼Œå½“å‰çº¿ç¨‹ä¸€èˆ¬æƒ…å†µä¸‹è¿›å…¥RUNNABLEçŠ¶æ€ï¼Œä¹Ÿæœ‰å¯èƒ½è¿›å…¥BLOCKEDçŠ¶æ€ï¼ˆå› ä¸ºjoinæ˜¯åŸºäºwaitå®ç°çš„ï¼‰ã€‚
- obj.wait()ï¼Œå½“å‰çº¿ç¨‹è°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œ==å½“å‰çº¿ç¨‹é‡Šæ”¾å¯¹è±¡é”ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—==ã€‚ä¾é notify()/notifyAll()å”¤é†’æˆ–è€…wait(long timeout) timeoutæ—¶é—´åˆ°è‡ªåŠ¨å”¤é†’ã€‚
- obj.notify()å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„å•ä¸ªçº¿ç¨‹ï¼Œé€‰æ‹©æ˜¯ä»»æ„æ€§çš„(æ ¹æ®JDKç‰ˆæœ¬ä¸åŒï¼Œåœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­å”¤é†’çš„çº¿ç¨‹åœ¨é˜Ÿåˆ—é‡Œé¢çš„ä½ç½®ä¸åŒ )ã€‚notifyAll()å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ã€‚
- LockSupport.park()/LockSupport.parkNanos(long nanos),LockSupport.parkUntil(long deadlines), å½“å‰çº¿ç¨‹è¿›å…¥WAITING/TIMED_WAITINGçŠ¶æ€ã€‚å¯¹æ¯”waitæ–¹æ³•,==ä¸éœ€è¦è·å¾—é”å°±å¯ä»¥è®©çº¿ç¨‹è¿›å…¥WAITING/TIMED_WAITINGçŠ¶æ€==ï¼Œéœ€è¦é€šè¿‡LockSupport.unpark(Thread thread)å”¤é†’ã€‚

  - å¹¶å‘ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€å¯¹è±¡
  - å½¢æˆæ¡ä»¶ï¼šé˜Ÿåˆ—+é”ğŸ”’
  - é”æœºåˆ¶
    - ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ä¼šå¯¼è‡´å…¶ä»–æ‰€æœ‰éœ€è¦æ­¤é”çš„çº¿ç¨‹æŒ‚èµ·
    - åŠ é”é‡Šæ”¾é”ä¼šå¯¼è‡´è¾ƒå¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œè°ƒåº¦å»¶æ—¶
    - å¦‚æœä¸€ä¸ªä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åœ¨ç­‰ä¸€ä¸ªä¼˜å…ˆçº§ä½çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œä¼šå¯¼è‡´ä¼˜å…ˆçº§å€’ç½®

  - çº¿ç¨‹ä¸å®‰å…¨çš„ä¾‹å­

```java
public class UnsafeBuyTicket {

    public static void main(String[] args) {
        BuyTicket station = new BuyTicket();

        new Thread(station, "haha").start();
        new Thread(station, "xixi").start();
        new Thread(station, "hehe").start();
    }
}

class BuyTicket implements Runnable{
    private int ticketNums = 10;
    boolean flag = true;//å¤–éƒ¨åœæ­¢æ–¹å¼

    @Override
    public void run() {
        while (flag){
            buy();
        }
    }

    private void buy(){
        if(ticketNums <= 0){
            flag = false;
            return;
        }
        try {
            Thread.sleep(50);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "å¼ ç¥¨");
    }
}
```

---

```java
public class UnsafeBank {
    public static void main(String[] args) {

        Account account = new Account(100,"åŸºé‡‘");
        Drawing boy = new Drawing(account, 50, "boy");
        Drawing girl = new Drawing(account, 100, "girl");

        boy.start();
        girl.start();
    }
}

class Account{
    int money;
    String name;

    //alt+insert
    public Account(int money, String name) {
        this.money = money;
        this.name = name;
    }
}

class Drawing extends Thread{
    Account account;
    int drawingMoney;
    int nowMoney;

    public Drawing(Account account, int drawingMoney, String name){
        super(name);
        this.account = account;
        this.drawingMoney = drawingMoney;
    }

    @Override
    public void run() {
        if(account.money - drawingMoney < 0){
            System.out.println(Thread.currentThread().getName() + "é’±ä¸å¤Ÿå–ä¸äº†");
            return;
        }

        //æ”¾å¤§é—®é¢˜çš„å‘ç”Ÿæ€§
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        account.money -= drawingMoney;
        nowMoney += drawingMoney;

        System.out.println(account.name + "è´¦æˆ·ä½™é¢:" + account.money);
        System.out.println(this.getName() + "æ‰‹é‡Œçš„é’±:" + nowMoney);
    }
    /*
åŸºé‡‘è´¦æˆ·ä½™é¢:-50
åŸºé‡‘è´¦æˆ·ä½™é¢:50
girlæ‰‹é‡Œçš„é’±:100
boyæ‰‹é‡Œçš„é’±:50
     */
}
```

---

```java
import java.util.ArrayList;
import java.util.List;

//çº¿ç¨‹ä¸å®‰å…¨çš„é›†åˆ
public class UnsafeList {
    public static void main(String[] args) {

        List<String> list = new ArrayList<String>();
        for (int i = 0; i < 10000; i++) {
            new Thread(() -> {
                list.add(Thread.currentThread().getName());
            }).start();
        }
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(list.size());
    }
    //ç»“æœä¸åˆ°10000
}
```
### æºç 
```java
// jdk1.8
public boolean add(E e) {
    ensureCapacityInternal(size + 1);
    elementData[size++] = e;
    return true;
}

// jdk11
public boolean add(E e) {
    modCount++;
    add(e, elementData, size);
    return true;
}
// å€ŸåŠ©ä¸´æ—¶å˜é‡så®šä½å¹¶èµ‹å€¼ï¼Œç„¶åé€šè¿‡size = s + 1ç»™sizeèµ‹æ–°å€¼
private void add(E e, Object[] elementData, int s) {
    if (s == elementData.length)
        elementData = grow();
    elementData[s] = e;
    size = s + 1;
}
```

å¾…å®Œå–„ã€‚ã€‚ã€‚





## åŒæ­¥æ–¹æ³•

  - synchronizedæ–¹æ³•æ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®ï¼Œæ¯ä¸ªå¯¹è±¡å¯¹åº”ä¸€æŠŠé”ï¼Œæ¯ä¸ªsynchronizedæ–¹æ³•å¿…é¡»è·å¾—è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡çš„é”æ‰èƒ½æ‰§è¡Œï¼Œå¦åˆ™çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œæ–¹æ³•ä¸€æ—¦æ‰§è¡Œå°±ä¼šç‹¬å è¯¥é”
  - ç¼ºé™·ï¼šè‹¥å°†ä¸€ä¸ªå¤§çš„æ–¹æ³•ç”³æ˜ä¸ºsynchronizedä¼šå½±å“æ•ˆç‡
  - æ–¹æ³•é‡Œéœ€è¦ä¿®æ”¹çš„èµ„æºæ‰éœ€è¦é”
  - synchronizedé»˜è®¤é”çš„æ˜¯this

```java
class UnsafeBuyTicket {

    public static void main(String[] args) {
        BuyTicket station = new BuyTicket();
        new Thread(station, "A").start();
        new Thread(station, "B").start();
        new Thread(station, "C").start();
    }
}

class BuyTicket implements Runnable{
    private int ticketNumbs = 10;
    boolean flag = true;//å¤–éƒ¨åœæ­¢æ–¹å¼
    @Override
    public void run() {
        while (flag){
            buy();
        }
    }

    //synchronized åŒæ­¥æ–¹æ³•ï¼Œé”çš„æ˜¯this
    private synchronized void buy(){
        if(ticketNumbs <= 0){
            flag = false;
            return;
        }
        try {
            Thread.sleep(50);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "æ‹¿åˆ°äº†ç¬¬" + ticketNumbs-- + "å¼ ç¥¨");
    }
/*    Aæ‹¿åˆ°äº†ç¬¬10å¼ ç¥¨
            Aæ‹¿åˆ°äº†ç¬¬9å¼ ç¥¨
    Aæ‹¿åˆ°äº†ç¬¬8å¼ ç¥¨
            Aæ‹¿åˆ°äº†ç¬¬7å¼ ç¥¨
    Aæ‹¿åˆ°äº†ç¬¬6å¼ ç¥¨
            Aæ‹¿åˆ°äº†ç¬¬5å¼ ç¥¨
    Cæ‹¿åˆ°äº†ç¬¬4å¼ ç¥¨
            Bæ‹¿åˆ°äº†ç¬¬3å¼ ç¥¨
    Bæ‹¿åˆ°äº†ç¬¬2å¼ ç¥¨
            Bæ‹¿åˆ°äº†ç¬¬1å¼ ç¥¨*/
}
```

- åŒæ­¥å—ï¼šsynchronizedï¼ˆObjï¼‰{}
- Objç§°ä¹‹ä¸ºåŒæ­¥ç›‘è§†å™¨
    - å¯ä»¥æ˜¯ä»»ä½•å¯¹è±¡ï¼Œæ¨èä½¿ç”¨å…±äº«èµ„æºä½œä¸ºåŒæ­¥ç›‘è§†å™¨
    - ==ç›‘è§†çš„å¯¹è±¡æ˜¯éœ€è¦å¢åˆ æ”¹çš„å¯¹è±¡ï¼ŒåŠä¼šå˜åŒ–çš„å¯¹è±¡==
    - åŒæ­¥æ–¹æ³•ä¸­ä¸éœ€è¦æŒ‡å®šåŒæ­¥ç›‘è§†å™¨ï¼ŒåŒæ­¥æ–¹æ³•ä¸­çš„åŒæ­¥ç›‘è§†å™¨å°±æ˜¯this

```java
class UnsafeBank {
    public static void main(String[] args) {

        Account account = new Account(100,"åŸºé‡‘");
        Drawing boy = new Drawing(account, 50, "boy");
        Drawing girl = new Drawing(account, 100, "girl");

        boy.start();
        girl.start();
    }
}

class Account{
    int money;
    String name;

    public Account(int money, String name) {
        this.money = money;
        this.name = name;
    }
}

class Drawing extends Thread{
    private Account account;
    int drawingMoney;
    int nowMoney;

    public Drawing(Account account, int drawingMoney, String name){
        super(name);
        this.account = account;
        this.drawingMoney = drawingMoney;
    }

    @Override
    public void run() {

        synchronized (account){
            if(account.money - drawingMoney < 0){
                System.out.println(Thread.currentThread().getName() + "é’±ä¸å¤Ÿå–ä¸äº†");
                return;
            }

            // æ”¾å¤§é—®é¢˜çš„å‘ç”Ÿæ€§
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            account.money -= drawingMoney;
            nowMoney += drawingMoney;

            System.out.println(account.name + "è´¦æˆ·ä½™é¢:" + account.money);
            System.out.println(this.getName() + "æ‰‹é‡Œçš„é’±:" + nowMoney);
        }
    }
/*    åŸºé‡‘è´¦æˆ·ä½™é¢:50
    boyæ‰‹é‡Œçš„é’±:50
    girlé’±ä¸å¤Ÿå–ä¸äº†*/
}
```

```java
import java.util.ArrayList;
import java.util.List;

// çº¿ç¨‹ä¸å®‰å…¨çš„é›†åˆ
class UnsafeList {
    public static void main(String[] args) {

        List<String> list = new ArrayList<>();
        for (int i = 0; i < 10000; i++) {
            new Thread(() -> {
                // é”çš„æ˜¯å˜åŒ–çš„é‡ï¼Œå¢åˆ æ”¹
                synchronized (list){
                    list.add(Thread.currentThread().getName());
                }
            }).start();
        }
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(list.size()); // 10000ä¸ª
    }
}
```

- CopyOnWriteArrayList

```java
import java.util.concurrent.CopyOnWriteArrayList;

public class MyJUC {

    public static void main(String[] args) {
        CopyOnWriteArrayList<String> list = new CopyOnWriteArrayList<String>();
        for (int i = 0; i < 10000; i++) {
            new Thread(()->{
                list.add(Thread.currentThread().getName());
            }).start();
        }

        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println(list.size());
    }
}
```

## æ­»é”
  - å››ä¸ªå¿…è¦æ¡ä»¶ï¼šäº’æ–¥æ¡ä»¶ã€è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ã€ä¸å¯å‰¥å¤ºæ¡ä»¶ã€å¾ªç¯ç­‰å¾…æ¡ä»¶

```java
public class DeadLock {

    public static void main(String[] args) {
        Makeup girl1 = new Makeup(0,"haha");
        Makeup girl2 = new Makeup(1,"xixi");

        girl1.start();
        girl2.start();
    }
}

class Lipstick{

}

class Mirror{

}

class Makeup extends Thread{
    static Lipstick lipstick = new Lipstick();
    static Mirror mirror = new Mirror();

    int choice;
    String girlName;

    Makeup(int choice, String girlName){
        this.choice = choice;
        this.girlName = girlName;
    }

    @Override
    public void run() {
        try {
            makeup();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    private void makeup() throws InterruptedException {
        if(choice==0){
            synchronized (lipstick){
                System.out.println(this.girlName + "è·å¾—å£çº¢çš„é”");
                Thread.sleep(1000);
                
                //æ­¤å¤„å’Œä¸Šä¸€ä¸ªsynchronizedå¹¶åˆ—æ—¶å°±èƒ½ç ´åæ­»é”æ¡ä»¶
                synchronized (mirror){
                    System.out.println(this.girlName + "è·å¾—é•œå­çš„é”");
                }
            }
        }else{
            synchronized (mirror){
                System.out.println(this.girlName + "è·å¾—é•œå­çš„é”");
                Thread.sleep(2000);

                //æ­¤å¤„å’Œä¸Šä¸€ä¸ªsynchronizedå¹¶åˆ—æ—¶å°±èƒ½ç ´åæ­»é”æ¡ä»¶
                synchronized (lipstick){
                    System.out.println(this.girlName + "è·å¾—å£çº¢çš„é”");
                }
            }
        }
    }
}
```

## Locké”
  - æ˜¾ç¤ºå®šä¹‰åŒæ­¥é”å®ç°åŒæ­¥
  - jvmèŠ±è´¹è¾ƒå°‘çš„æ—¶é—´è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½
  - ==lockåªæœ‰ä»£ç å—é”ï¼Œsynchronizedæœ‰ä»£ç å—å’Œæ–¹æ³•é”==

```java
import java.util.concurrent.locks.ReentrantLock;

class MyLock {

    public static void main(String[] args) {
        TestLock testLock = new TestLock();
        new Thread(testLock).start();
        new Thread(testLock).start();
        new Thread(testLock).start();

    }
}

class TestLock implements Runnable{
    int ticketNum = 10;

    // å®šä¹‰locké”
    private final ReentrantLock lock = new ReentrantLock();

    @Override
    public void run() {
        while(true){
            try{
                lock.lock(); // åŠ é”
                if(ticketNum>0){
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    System.out.println(ticketNum--);
                }else{
                    break;
                }
            }finally {
                lock.unlock(); // è§£é”
            }
        }
    }
}
```

### æºç 

```java
public ReentrantLock() {
    sync = new NonfairSync(); // é»˜è®¤ä½¿ç”¨éå…¬å¹³é”
}

public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

## çº¿ç¨‹é€šä¿¡

  - wait()ï¼šè¡¨ç¤ºçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é€šçŸ¥ï¼Œä¸sleepä¸åŒï¼Œ==ä¼šé‡Šæ”¾é”==
  - wait(long timeout)ï¼šæŒ‡å®šç­‰å¾…çš„æ¯«ç§’æ•°
  - notify()ï¼šå”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹
  - notifyAll()ï¼šå”¤é†’åŒä¸€ä¸ªå¯¹è±¡ä¸Šæ‰€æœ‰è°ƒç”¨wait()æ–¹æ³•çš„çº¿ç¨‹ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼˜å…ˆè°ƒåº¦
  - ä»¥ä¸Šéƒ½æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œ==éƒ½åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥ä»£ç å—ä¸­ä½¿ç”¨==ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸IIIegalMonitorStateException
- åˆ©ç”¨ç¼“å†²åŒºï¼šç®¡ç¨‹æ³•

å¾…å®Œå–„ã€‚ã€‚ã€‚

- åˆ©ç”¨ä¿¡å·ç¯

```java
class MyPC {
    public static void main(String[] args) {
        // è¡¨æ¼”ä¸€ä¸ªå®Œæ¯•åè§‚çœ‹è¿™ä¸ªèŠ‚ç›®
        TV tv = new TV();
        new Player(tv).start();
        new Watcher(tv).start();
    }
}

// ç”Ÿäº§è€…æ¼”å‘˜
class Player extends Thread {
    private TV tv;

    public Player(TV tv) {
        this.tv = tv;
    }

    @Override
    public void run() {
        for (int i = 0; i < 20; i++) {
            if (i % 2 == 0) {
                this.tv.play("haha");
            } else {
                this.tv.play("xixi");
            }
        }
    }
}

// æ¶ˆè´¹è€…è§‚ä¼—
class Watcher extends Thread {
    private TV tv;

    public Watcher(TV tv) {
        this.tv = tv;
    }

    @Override
    public void run() {
        for (int i = 0; i < 20; i++) {
            tv.watch();
        }
    }
}

// äº§å“èŠ‚ç›®
class TV {
    // æ¼”å‘˜è¡¨æ¼”ï¼Œè§‚ä¼—ç­‰å¾… T
    // è§‚ä¼—è§‚çœ‹ï¼Œæ¼”å‘˜ç­‰å¾… F
    private String voice;
    boolean flag = true;

    // è¡¨æ¼”
    public synchronized void play(String voice) {
        if (!flag) {
            // è§‚ä¼—è§‚çœ‹ä¸Šä¸ªèŠ‚ç›®ï¼Œæ¼”å‘˜ç­‰å¾… F
            try {
                this.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        // å¼€å§‹è¡¨æ¼”
        System.out.println("æ¼”å‘˜è¡¨æ¼”äº†" + voice);
        // é€šçŸ¥è§‚ä¼—è§‚çœ‹
        this.notifyAll();// é€šçŸ¥å”¤é†’
        this.voice = voice;
        this.flag = !this.flag;
    }

    // è§‚çœ‹
    public synchronized void watch() {
        if (flag) {
            // æ¼”å‘˜è¡¨æ¼”ï¼Œè§‚ä¼—ç­‰å¾… T
            try {
                this.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println("è§‚çœ‹äº†" + voice);
        //é€šçŸ¥æ¼”å‘˜è¡¨æ¼”
        this.notifyAll();//é€šçŸ¥å”¤é†’
        this.flag = !this.flag;
    }
}
```

## çº¿ç¨‹æ± 

```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

class MyPool {

    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹æ±  å¤§å°ä¸º10
        ExecutorService service = Executors.newFixedThreadPool(10);

        // æ‰§è¡Œ
        service.execute(new MyThread());
        service.execute(new MyThread());
        service.execute(new MyThread());
        service.execute(new MyThread());

        // å…³é—­è¿æ¥
        service.shutdown();
    }
}

class MyThread extends Thread{
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName());
    }
}
/*
    pool-1-thread-1
    pool-1-thread-3
    pool-1-thread-2
    pool-1-thread-4
*/
```

