---
title: çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ
date: 2025-07-09 22:09:06 +0800
categories: [cpp, cpp concurrency]
tags: [CPP, Concurrency]
description: "C++ ä¸­çº¿ç¨‹å¯åŠ¨åéœ€è°ƒç”¨ join() ç­‰å¾…å…¶ç»“æŸï¼Œæˆ–ç”¨ detach() åˆ†ç¦»çº¿ç¨‹åå°è¿è¡Œï¼Œå¦åˆ™ææ„æ—¶æŠ¥é”™ã€‚é¿å…çº¿ç¨‹è®¿é—®å·²é”€æ¯å±€éƒ¨å˜é‡ã€‚æ¨èç”¨ RAII è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€‚"
---
## çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ

æ¯ä¸ªç¨‹åºè‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼šä¸»çº¿ç¨‹ï¼ˆæ‰§è¡Œ `main()` å‡½æ•°ï¼‰ã€‚ä½¿ç”¨ `std::thread` å¯ä»¥åˆ›å»ºæ›´å¤šçº¿ç¨‹ï¼Œå®ƒä»¬ä¸ä¸»çº¿ç¨‹**å¹¶å‘è¿è¡Œ**ã€‚

å½“çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Œå…¶å¯¹åº”çš„ `std::thread` å¯¹è±¡å¿…é¡»è¢«å¦¥å–„å¤„ç†ï¼ˆå¦‚ `join()` æˆ– `detach()`ï¼‰ï¼Œå¦åˆ™ç¨‹åºä¼šå¼‚å¸¸ç»ˆæ­¢ã€‚

### å¯åŠ¨çº¿ç¨‹

#### å¯åŠ¨çº¿ç¨‹çš„åŸºæœ¬ç”¨æ³•

```cpp
void do_some_work();
std::thread my_thread(do_some_work);
```

åˆ›å»º `std::thread` å¯¹è±¡æ—¶å³å¯åŠ¨çº¿ç¨‹ã€‚éœ€åŒ…å« `<thread>` å¤´æ–‡ä»¶ã€‚

#### ä½¿ç”¨å‡½æ•°å¯¹è±¡

```cpp
class background_task {
public:
  void operator()() const {
    do_something();
    do_something_else();
  }
};

background_task f;
std::thread my_thread(f);
```

#### æœ€ä»¤äººå¤´ç—›çš„è¯­æ³•è§£æï¼ˆMost Vexing Parseï¼‰

```cpp
std::thread my_thread(background_task()); // âŒ å®é™…ä¸Šæ˜¯å‡½æ•°å£°æ˜ï¼
```

**çœ‹èµ·æ¥åƒæ˜¯æ„é€ ä¸€ä¸ª `std::thread` å¯¹è±¡ `my_thread`ï¼Œä¼ å…¥ `background_task()` ä½œä¸ºå‚æ•°**ï¼Œä½†å®é™…ä¸Šï¼Œ**C++ ç¼–è¯‘å™¨ä¼šå°†å®ƒè§£æä¸ºå‡½æ•°å£°æ˜**ï¼Œè€Œä¸æ˜¯å¯¹è±¡å®šä¹‰ã€‚

ä» C++ ç¼–è¯‘å™¨çš„è§†è§’æ¥çœ‹ï¼Œè¿™ä¸ªè¯­æ³•åŒ¹é…äº†ä¸‹é¢è¿™ç§å½¢å¼çš„å‡½æ•°å£°æ˜ï¼š

```css
è¿”å›ç±»å‹       å‡½æ•°å     (       å‚æ•°       );
----------    --------   --------------------
std::thread   my_thread  (background_task(*)())
```

å³ï¼šè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å£°æ˜ï¼Œå‡½æ•°åæ˜¯ `my_thread`ï¼Œå®ƒçš„**å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ**ï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª**æ— å‚æ•°ã€è¿”å›ç±»å‹ä¸º `background_task` çš„å‡½æ•°**ï¼Œæ•´ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª `std::thread` å¯¹è±¡ã€‚

æ‰€ä»¥å°½é‡é¿å…å†™å½¢å¦‚ `Type name(Type())` çš„ä»£ç ã€‚

é¿å…æ–¹æ³•ï¼š

##### ä½¿ç”¨é¢å¤–ä¸€å¯¹æ‹¬å·

```cpp
std::thread my_thread((background_task()));  // ä½¿ç”¨åŒæ‹¬å·
```

å¤–å±‚æ‹¬å·å¼ºåˆ¶ç¼–è¯‘å™¨å°†å…¶è§£é‡Šä¸ºæ„é€ å‡½æ•°å‚æ•°ï¼Œè€Œä¸æ˜¯å‡½æ•°å£°æ˜ã€‚

##### ä½¿ç”¨ç»Ÿä¸€åˆå§‹åŒ–è¯­æ³•ï¼ˆC++11 èµ·ï¼‰

```cpp
std::thread my_thread{background_task()};    // ä½¿ç”¨ç»Ÿä¸€åˆå§‹åŒ–è¯­æ³•
```

å¤§æ‹¬å·åˆå§‹åŒ–ä¸ä¼šè¢«è§£é‡Šä¸ºå‡½æ•°å£°æ˜ã€‚

#### ä½¿ç”¨ Lambda è¡¨è¾¾å¼

```cpp
std::thread my_thread([] {
  do_something();
  do_something_else();
});
```

### ç­‰å¾…çº¿ç¨‹å®Œæˆï¼ˆjoinï¼‰

çº¿ç¨‹è¿è¡Œåå¿…é¡»ï¼š

- `join()`ï¼šç­‰å¾…çº¿ç¨‹å®Œæˆ

- `detach()`ï¼šåˆ†ç¦»çº¿ç¨‹ï¼Œåå°è¿è¡Œ

- å¦åˆ™ç¨‹åºå´©æºƒï¼ˆææ„æ—¶æŠ¥ `std::terminate()`ï¼‰

  - `std::thread` çš„ææ„å‡½æ•°è¿™ä¹ˆå†™çš„

    ```cpp
    ~thread() {
        if (joinable()) {
            std::terminate(); // å´©æºƒï¼šæ²¡å¤„ç†è¿™ä¸ªçº¿ç¨‹
        }
    }
    ```

  - ä¹Ÿå°±æ˜¯è¯´ï¼š

    - å¦‚æœçº¿ç¨‹è¿˜ **joinableï¼ˆå¯è¿æ¥ï¼‰**ï¼Œè¯´æ˜å®ƒæ²¡è¢«å¤„ç†ï¼›
    - ææ„æ—¶å¦‚æœå¿˜äº† `join()` æˆ– `detach()`ï¼Œå°±ç›´æ¥è°ƒç”¨ `std::terminate()`ã€‚

ç¤ºä¾‹ï¼šçº¿ç¨‹è®¿é—®äº†å·²ç»é”€æ¯çš„å±€éƒ¨å˜é‡

```cpp
struct func {
  int& i;
  func(int& i_) : i(i_) {}
  void operator() () {
    for (unsigned j = 0; j < 1000000; ++j) {
      do_something(i);  // æ½œåœ¨è®¿é—®æ— æ•ˆå¼•ç”¨
    }
  }
};

void oops() {
  int some_local_state = 0;
  func my_func(some_local_state);
  std::thread my_thread(my_func);
  my_thread.detach(); // âŒ æ²¡æœ‰ç­‰å¾…çº¿ç¨‹ç»“æŸ
} // âŒ çº¿ç¨‹ä»è¿è¡Œï¼Œä½†å±€éƒ¨å˜é‡é”€æ¯
```

- **ä¸»çº¿ç¨‹ä¸­ `some_local_state` æ˜¯å±€éƒ¨å˜é‡**ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸåˆ° `oops()` å‡½æ•°ç»“æŸä¸ºæ­¢ã€‚
- **æ–°çº¿ç¨‹é€šè¿‡å¼•ç”¨è®¿é—®å®ƒ**ï¼Œå¦‚æœæœªç­‰å¾…çº¿ç¨‹ç»“æŸï¼ˆå³ä½¿ç”¨ `detach()`ï¼‰ï¼Œæ–°çº¿ç¨‹å¯èƒ½åœ¨å±€éƒ¨å˜é‡é”€æ¯åä»å°è¯•è®¿é—®å®ƒã€‚
- è¿™æ˜¯ä¸€ç§å…¸å‹çš„å¤šçº¿ç¨‹**æ‚¬ç©ºå¼•ç”¨ï¼ˆDangling Referenceï¼‰**é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è¡Œä¸ºå¼‚å¸¸ã€‚

| ğŸ§µ ä¸»çº¿ç¨‹æ‰§è¡Œæ­¥éª¤                       | ğŸ”€ æ–°çº¿ç¨‹æ‰§è¡Œæ­¥éª¤                                              |
| -------------------------------------- | ------------------------------------------------------------- |
| ä½¿ç”¨ `some_local_state` æ„é€  `my_func` |                                                               |
| åˆ›å»ºæ–°çº¿ç¨‹ `my_thread`                 |                                                               |
|                                        | å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡Œ `func::operator()`                             |
|                                        | `do_something(i)` ä½¿ç”¨ `some_local_state` çš„å¼•ç”¨              |
| è°ƒç”¨ `my_thread.detach()`              |                                                               |
| `some_local_state` è¢«é”€æ¯              | çº¿ç¨‹ä»åœ¨è¿è¡Œï¼Œå¯èƒ½ç»§ç»­è®¿é—® `some_local_state`ï¼ˆå·²é”€æ¯ï¼‰       |
| å‡½æ•° `oops()` ç»“æŸ                     | è‹¥çº¿ç¨‹ä»æ‰§è¡Œ `do_something(i)`ï¼Œåˆ™è®¿é—®æ— æ•ˆå¼•ç”¨ â†’ âŒ æœªå®šä¹‰è¡Œä¸º |

### ç‰¹æ®Šæƒ…å†µä¸‹çš„ç­‰å¾…

çº¿ç¨‹å¼‚å¸¸æœŸé—´ä¹Ÿè¦ç¡®ä¿è°ƒç”¨ `join()`ã€‚å¦åˆ™ä¼šå› ä¸ºæ²¡æœ‰æ±‡å…¥çº¿ç¨‹å¯¼è‡´ç¨‹åºå´©æºƒã€‚

ç¤ºä¾‹ï¼šå¼‚å¸¸ä¿æŠ¤ä¸‹çš„ join

```cpp
struct func; // åŒä¸Š

void f() {
  int some_local_state = 0;
  func my_func(some_local_state);
  std::thread t(my_func);
  try {
    do_something_in_current_thread();
  } catch (...) {
    t.join();  // â‘  å¼‚å¸¸æ—¶ç¡®ä¿çº¿ç¨‹ç»“æŸ
    throw;
  }
  t.join();    // â‘¡ æ­£å¸¸è·¯å¾„ä¹Ÿç­‰å¾…çº¿ç¨‹ç»“æŸ
}
```

### RAIIé£æ ¼çš„çº¿ç¨‹ä¿æŠ¤ï¼ˆæ¨èï¼‰

ä½¿ç”¨ææ„å‡½æ•°è‡ªåŠ¨è°ƒç”¨ `join()`ï¼Œé¿å…å¿˜è®°æˆ–å¼‚å¸¸è·³è¿‡ã€‚

```cpp
class thread_guard {
  std::thread& t;
public:
  explicit thread_guard(std::thread& t_): t(t_) {}
  ~thread_guard() {
    if (t.joinable()) {
      t.join();  // â‘  ç¡®ä¿çº¿ç¨‹æ±‡å…¥
    }
  }
  thread_guard(thread_guard const&) = delete;       // â‘¡ ç¦æ­¢æ‹·è´
  thread_guard& operator=(thread_guard const&) = delete;
};

void f() {
  int some_local_state = 0;
  func my_func(some_local_state);
  std::thread t(my_func);
  thread_guard g(t);  // â‘¢ RAII ä¿è¯å®‰å…¨
  do_something_in_current_thread();
} // â‘£ ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨ join
```

### åå°è¿è¡Œçº¿ç¨‹ï¼ˆdetachï¼‰

`detach()` è¡¨ç¤ºè®©çº¿ç¨‹åœ¨åå°è¿è¡Œï¼Œå³æˆä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆdaemon threadï¼‰ï¼š

```cpp
std::thread t(do_background_work);
t.detach();
assert(!t.joinable()); // å·²åˆ†ç¦»
```

ä½¿ç”¨ `t.joinable()` åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯è¢« joinã€‚

ç¤ºä¾‹ï¼šå¤šæ–‡æ¡£ç¼–è¾‘å™¨ä¸­ä½¿ç”¨åˆ†ç¦»çº¿ç¨‹

```cpp
void edit_document(std::string const& filename) {
  open_document_and_display_gui(filename);
  while (!done_editing()) {
    user_command cmd = get_user_input();
    if (cmd.type == open_new_document) {
      std::string const new_name = get_filename_from_user();
      std::thread t(edit_document, new_name);  // â‘  æ–°çº¿ç¨‹æ‰“å¼€æ–°æ–‡æ¡£
      t.detach();  // â‘¡ åˆ†ç¦»çº¿ç¨‹åå°è¿è¡Œ
    } else {
      process_user_input(cmd);
    }
  }
}
```

ç”¨æˆ·æ‰“å¼€æ–°æ–‡æ¡£æ—¶ï¼Œåˆ›å»ºæ–°çº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªæ–‡æ¡£å¤„ç†çº¿ç¨‹äº’ä¸å¹²æ‰°ï¼Œé€‚åˆä½¿ç”¨åˆ†ç¦»çº¿ç¨‹ã€‚

### å¯¹æ¯”

#### å›¾è§£

```css
ä¸»çº¿ç¨‹
â”‚
â”œâ”€ åˆ›å»º std::thread t(...)
â”‚
â”œâ”€ join() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆåŒæ­¥ï¼‰
â”‚
â””â”€ detach() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å­çº¿ç¨‹åå°ç‹¬ç«‹æ‰§è¡Œï¼ˆå¼‚æ­¥ï¼Œè‡ªå·±è·‘ï¼‰
```

#### åŸºç¡€å®šä¹‰å¯¹æ¯”

| åŠŸèƒ½            | `join()`                           | `detach()`                 |
| --------------- | ---------------------------------- | -------------------------- |
| å«ä¹‰            | ä¸»åŠ¨ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•               | åˆ†ç¦»çº¿ç¨‹ï¼Œè®©å…¶ç‹¬ç«‹åå°è¿è¡Œ |
| æ‰€å±æƒ          | è°ƒç”¨åçº¿ç¨‹å½’ä¸»çº¿ç¨‹ç®¡ç†             | è°ƒç”¨åçº¿ç¨‹å½’ç³»ç»Ÿç®¡ç†       |
| é˜»å¡è¡Œä¸º        | âœ… é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œ | âŒ ä¸é˜»å¡ï¼Œç«‹å³è¿”å›         |
| æ¸…ç†èµ„æº        | âœ… è‡ªåŠ¨é‡Šæ”¾çº¿ç¨‹èµ„æº                 | âœ… ç³»ç»Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶è‡ªåŠ¨æ¸…ç† |
| æ˜¯å¦ joinable() | âŒ join åä¸å¯ joinable             | âŒ detach åä¸å¯ joinable   |

#### ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯                   | æ¨èæ“ä½œ   | ç†ç”±                                                       |
| ---------------------- | ---------- | ---------------------------------------------------------- |
| éœ€è¦ç­‰å¾…çº¿ç¨‹ç»“æœ       | `join()`   | ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œä¾‹å¦‚ï¼šä¸‹è½½å®Œæˆã€è®¡ç®—å®Œæˆ                 |
| å­çº¿ç¨‹éå…³é”®ã€åå°è¿è¡Œ | `detach()` | æ— éœ€ç­‰å¾…çº¿ç¨‹ï¼Œä¾‹å¦‚ï¼šæ—¥å¿—ã€å¿ƒè·³ã€ç›‘æ§ã€ç¼“å­˜æ¸…ç†             |
| åˆ›å»ºçº¿ç¨‹ä½†å¿˜è®°å¤„ç†     | âŒ ç¨‹åºå´©æºƒ | å¦‚æœæ—¢ä¸ `join` ä¹Ÿä¸ `detach`ï¼Œææ„æ—¶ä¼š `std::terminate()` |

#### æ³¨æ„äº‹é¡¹å¯¹æ¯”

| é¡¹ç›®               | `join()`                                  | `detach()`                             |
| ------------------ | ----------------------------------------- | -------------------------------------- |
| æ˜¯å¦å¯ä»¥å¤šæ¬¡è°ƒç”¨   | âŒ ä¸å¯ä»¥å¤šæ¬¡ join                         | âŒ ä¸å¯ä»¥å¤šæ¬¡ detach                    |
| æ˜¯å¦å¯ä»¥æ··ç”¨       | âŒ join å’Œ detach åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼ˆæˆ–ä¸è°ƒç”¨ï¼‰ | å¦åˆ™ç¨‹åºå´©æºƒ                           |
| é”€æ¯å‰æ˜¯å¦å¿…é¡»è°ƒç”¨ | âœ… å¿…é¡»è°ƒç”¨ï¼ˆjoin æˆ– detach è‡³å°‘ä¸€ä¸ªï¼‰     | âœ… å¿…é¡»è°ƒç”¨ï¼ˆå¦åˆ™ææ„å´©æºƒï¼‰             |
| çº¿ç¨‹å®‰å…¨æ€§         | å®‰å…¨ï¼Œèµ„æºå›æ”¶æ˜ç¡®                        | âš ï¸ å±é™©ï¼Œéœ€ç¡®ä¿çº¿ç¨‹ä¸­ä¸è®¿é—®æ‚¬ç©ºå¯¹è±¡     |
| è°ƒè¯•å‹å¥½æ€§         | âœ… è°ƒè¯•æ–¹ä¾¿ï¼Œä¸»çº¿ç¨‹å¯æ•è·å¼‚å¸¸æˆ–æ—¥å¿—        | âŒ è°ƒè¯•å›°éš¾ï¼Œåå°çº¿ç¨‹å¥”æºƒä½ å¯èƒ½éƒ½ä¸çŸ¥é“ |

### æ€»ç»“

| æ“ä½œ       | å«ä¹‰ä¸åœºæ™¯                                 |
| ---------- | ------------------------------------------ |
| `join()`   | ä¸»åŠ¨ç­‰å¾…çº¿ç¨‹å®Œæˆï¼Œé‡Šæ”¾èµ„æºï¼Œå¸¸è§„æ¨èæ–¹å¼   |
| `detach()` | åˆ†ç¦»çº¿ç¨‹ï¼Œåå°è¿è¡Œï¼Œé€‚ç”¨äº fire-and-forget |
| RAII       | ç”¨ç±»å°è£…çº¿ç¨‹ï¼Œè‡ªåŠ¨åœ¨ææ„æ—¶è°ƒç”¨ `join()`    |
| é¿å…é”™è¯¯   | ä¸è¦åœ¨çº¿ç¨‹ä¸­è®¿é—®å·²é”€æ¯çš„å±€éƒ¨å˜é‡å¼•ç”¨       |
