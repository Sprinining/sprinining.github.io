---
title: å†…è”å‡½æ•°ä¸constexprå‡½æ•°
date: 2025-05-19 05:30:31 +0800
categories: [cpp, cpp basics]
tags: [CPP, Inline, Constexpr]
description: 
---
## å†…è”å‡½æ•°ä¸constexprå‡½æ•°

### å†…è”å‡½æ•°

C++ ä¸­çš„ **å†…è”å‡½æ•°ï¼ˆinline functionï¼‰** æ˜¯ä¸€ç§ç”¨äºæå‡å°å‡½æ•°æ‰§è¡Œæ•ˆç‡çš„æŠ€æœ¯ï¼Œé€šè¿‡åœ¨ç¼–è¯‘é˜¶æ®µå°†å‡½æ•°è°ƒç”¨å¤„æ›¿æ¢ä¸ºå‡½æ•°ä½“ä»£ç ï¼Œä»è€Œé¿å…å‡½æ•°è°ƒç”¨å¸¦æ¥çš„å¼€é”€ï¼ˆå¦‚å‹æ ˆã€è·³è½¬ç­‰ï¼‰ã€‚

#### åŸºæœ¬è¯­æ³•

```c++
inline è¿”å›ç±»å‹ å‡½æ•°å(å‚æ•°åˆ—è¡¨) {
    // å‡½æ•°ä½“
}
```

ç¤ºä¾‹ï¼š

```c++
#include <iostream>
using namespace std;

inline int add(int a, int b) {
    return a + b;
}

int main() {
    int x = 3, y = 5;
    cout << "Sum: " << add(x, y) << endl;
    return 0;
}
```

ç»è¿‡å†…è”ä¼˜åŒ–åï¼Œ`add(x, y)` ä¼šè¢«ç›´æ¥æ›¿æ¢ä¸ºå…¶å‡½æ•°ä½“ `x + y`ï¼Œæ‰€ä»¥ä¸»å‡½æ•°å¤§è‡´ä¼šè¢«ç¼–è¯‘å™¨é‡å†™ä¸ºè¿™æ ·ï¼š

```c++
int main() {
    int x = 3, y = 5;
    std::cout << "Sum: " << (x + y) << std::endl;
    return 0;
}
```

> æ³¨æ„ï¼šè¿™åªæ˜¯é€»è¾‘ä¸Šçš„ç­‰ä»·æ›¿æ¢ï¼Œ**ç¼–è¯‘å™¨æœ€ç»ˆç”Ÿæˆçš„æœºå™¨ç å¯èƒ½è¿œæ¯”è¿™ä¸ªå¤æ‚ï¼Œä¹Ÿä¼šå—ç¼–è¯‘é€‰é¡¹å½±å“ï¼ˆå¦‚ `-O2`, `-O3` ä¼˜åŒ–çº§åˆ«ï¼‰**

#### ä½¿ç”¨å†…è”å‡½æ•°çš„ä¼˜ç‚¹

- **å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€**ï¼ˆå°¤å…¶é€‚ç”¨äºé¢‘ç¹è°ƒç”¨çš„çŸ­å°å‡½æ•°ï¼‰

- **å¢å¼ºå¯è¯»æ€§**ï¼Œåƒå®é‚£æ ·æ›¿ä»£ä»£ç å—ï¼Œä½†å…·å¤‡ç±»å‹æ£€æŸ¥ä¸ä½œç”¨åŸŸç®¡ç†

#### æ³¨æ„äº‹é¡¹

1. **é€‚åˆçŸ­å°å‡½æ•°**ï¼š
   - å¤ªå¤æ‚çš„å‡½æ•°å¯èƒ½ä¸ä¼šè¢«ç¼–è¯‘å™¨å†…è”ï¼ˆå³ä½¿ä½ å†™äº† `inline`ï¼‰

2. **ç¼–è¯‘å™¨å†³å®šæ˜¯å¦å†…è”**ï¼š
   - `inline` åªæ˜¯å»ºè®®ï¼Œç°ä»£ç¼–è¯‘å™¨å¯èƒ½æ ¹æ®ä¼˜åŒ–ç­–ç•¥é€‰æ‹©æ˜¯å¦çœŸæ­£å†…è”

3. **é¿å…åœ¨å¤´æ–‡ä»¶ä¸­æ»¥ç”¨**ï¼š
   - å¤šå¤„å®šä¹‰åŒä¸€å‡½æ•°æ—¶åº”ä½¿ç”¨ `inline` ä»¥é¿å…é“¾æ¥å†²çªï¼ˆç‰¹åˆ«åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å‡½æ•°æ—¶ï¼‰

4. **ä¸èƒ½é€’å½’å†…è”**ï¼š
   - ç¼–è¯‘å™¨é€šå¸¸ä¸ä¼šå¯¹é€’å½’å‡½æ•°å†…è”

| æƒ…å†µ                                 | æ˜¯å¦å»ºè®®å†…è”                   |
| ------------------------------------ | ------------------------------ |
| å‡½æ•°ä½“éå¸¸çŸ­ï¼ˆå¦‚ 1~3 è¡Œï¼‰            | âœ… é€‚åˆ                         |
| å‡½æ•°ä½“è¾ƒå¤æ‚ï¼ˆæœ‰å¾ªç¯/é€»è¾‘åˆ†æ”¯ï¼‰      | âŒ ä¸å»ºè®®                       |
| å‡½æ•°é¢‘ç¹è¢«è°ƒç”¨                       | âœ… é€‚åˆ                         |
| å‡½æ•°è°ƒç”¨é¢‘ç‡ä½/ç¼–è¯‘æ—¶é—´æ•æ„Ÿ          | âŒ ä¸å»ºè®®                       |
| éœ€è¦è·¨æ–‡ä»¶è°ƒç”¨ï¼ˆå‡½æ•°æ”¾ .cpp æ–‡ä»¶ä¸­ï¼‰ | âŒ ä¸èƒ½å†…è”ï¼ˆå¿…é¡»å¤´æ–‡ä»¶ä¸­å®šä¹‰ï¼‰ |

#### ODRï¼ˆOne Definition Ruleï¼‰

C++ è¦æ±‚ **æ¯ä¸ªå‡½æ•°æˆ–å˜é‡åœ¨æ•´ä¸ªç¨‹åºä¸­åªèƒ½æœ‰ä¸€ä¸ªå®šä¹‰**ï¼ˆå³ ODRï¼šOne Definition Ruleï¼‰ã€‚å¦‚æœä½ æŠŠå‡½æ•°å®šä¹‰ï¼ˆ**éå£°æ˜ï¼**ï¼‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨å¤šä¸ª `.cpp` æ–‡ä»¶ä¸­ `#include` äº†è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œå°±ç›¸å½“äºåœ¨å¤šä¸ªåœ°æ–¹éƒ½å®šä¹‰äº†ä¸€éåŒä¸€ä¸ªå‡½æ•°ã€‚

è¿™å°±ä¼šå¯¼è‡´ **é“¾æ¥é”™è¯¯ï¼ˆmultiple definitionï¼‰**ï¼š

```bash
error: multiple definition of 'xxx'; first defined here...
```

å°†å‡½æ•°æ ‡è®°ä¸º `inline`ï¼Œå°±å‘Šè¯‰ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ï¼š

> â€œè¿™ä¸ªå‡½æ•°å³ä½¿åœ¨å¤šä¸ªç¼–è¯‘å•å…ƒä¸­å®šä¹‰äº†ï¼Œåªè¦å®šä¹‰å†…å®¹ç›¸åŒï¼Œæ˜¯å¯ä»¥å…±å­˜çš„ã€‚â€

è¿™æ˜¯ C++ æ ‡å‡†ä¸­ç‰¹æ„ä¸ºæ”¯æŒå¤´æ–‡ä»¶ä¸­å®šä¹‰å‡½æ•°è€Œè®¾è®¡çš„æœºåˆ¶ã€‚

#### ç±»ä¸å†…è”å‡½æ•°

ç±»ä¸­å®šä¹‰çš„å‡½æ•°é»˜è®¤æ˜¯å†…è”çš„ï¼Œç¤ºä¾‹ï¼š

```cpp
class MyClass {
public:
    int getX() const { return x; }  // åœ¨ç±»å®šä¹‰ä¸­å†™äº†å‡½æ•°ä½“ï¼Œå°±æ˜¯å†…è”å‡½æ•°
private:
    int x = 10;
};
```

è¿™ä¸ª `getX()` å‡½æ•°æ˜¯ä¸€ä¸ª**å†…è”æˆå‘˜å‡½æ•°**ï¼Œç­‰ä»·äºå†™åœ¨ç±»å¤–å¹¶åŠ ä¸Š `inline`ï¼š

```cpp
class MyClass {
public:
    int getX() const;
private:
    int x = 10;
};

inline int MyClass::getX() const {
    return x;
}
```

 ä¸‰ç§å†™æ³•éƒ½å¯ä»¥è®©å‡½æ•°æˆä¸ºâ€œå†…è”å‡½æ•°â€ï¼š

```cpp
// å†™æ³•ä¸€ï¼šç±»å†…å®šä¹‰ï¼ˆè‡ªåŠ¨å†…è”ï¼‰
class A {
    int get() const { return 1; }
};

// å†™æ³•äºŒï¼šç±»å¤–å®šä¹‰ + inline
class B {
    int get() const;
};
inline int B::get() const { return 2; }

// å†™æ³•ä¸‰ï¼šç±»å†…å£°æ˜ + inline å…³é”®å­—ï¼ˆå¯é€‰ï¼‰
class C {
    inline int get() const { return 3; } // inline æ˜¯å¯åŠ å¯ä¸åŠ 
};
```

### constexpr å‡½æ•°

`constexpr` å‡½æ•°æ˜¯ C++11 å¼•å…¥çš„ä¸€ç§å‡½æ•°ç±»å‹ï¼Œç”¨äº **åœ¨ç¼–è¯‘æœŸå°±èƒ½æ±‚å€¼çš„å‡½æ•°**ã€‚è¿™å¯¹äºå†™é«˜æ•ˆã€ç±»å‹å®‰å…¨çš„ **å¸¸é‡è¡¨è¾¾å¼è®¡ç®—é€»è¾‘** éå¸¸æœ‰ç”¨ã€‚

#### åŸºæœ¬æ¦‚å¿µ

```cpp
constexpr è¿”å›ç±»å‹ å‡½æ•°å(å‚æ•°åˆ—è¡¨) {
    // å‡½æ•°ä½“å¿…é¡»æ˜¯èƒ½åœ¨ç¼–è¯‘æœŸæ±‚å€¼çš„ä»£ç 
}
```

> å½“æ‰€æœ‰å‚æ•°æ˜¯å¸¸é‡è¡¨è¾¾å¼æ—¶ï¼Œ`constexpr` å‡½æ•°å¯ä»¥åœ¨ç¼–è¯‘æœŸç›´æ¥è¢«æ±‚å€¼ï¼Œå°±åƒå¸¸é‡ä¸€æ ·ã€‚

ç¤ºä¾‹ 1ï¼šæ™®é€šçš„ `constexpr` å‡½æ•°

```cpp
constexpr int square(int x) {
    return x * x;
}

int main() {
    constexpr int a = square(5);  // ç¼–è¯‘æœŸè®¡ç®—ï¼Œa = 25
    //  ç¼–è¯‘æœŸå¸¸é‡è®¡ç®—ï¼šæé«˜æ€§èƒ½ï¼Œæ²¡æœ‰è¿è¡Œæ—¶è°ƒç”¨å¼€é”€ï¼Œå¯ä»¥ç”¨äºå¸¸é‡ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚æ•°ç»„å¤§å°ã€switch çš„ case æ ‡ç­¾ç­‰ï¼‰
    
    int b = 10;
    int c = square(b);           // è¿è¡ŒæœŸè®¡ç®—ï¼ˆå› ä¸º b ä¸æ˜¯å¸¸é‡ï¼‰
    // å³ä½¿ square æ˜¯ constexprï¼Œå®ƒä¹Ÿå¯ä»¥åƒæ™®é€šå‡½æ•°ä¸€æ ·åœ¨è¿è¡Œæ—¶è°ƒç”¨ï¼Œè¿™è®©å‡½æ•°å¯ä»¥åœ¨ä¸¤ç§åœºæ™¯ä¸‹å¤ç”¨ï¼Œè€Œä¸æ˜¯å†å†™ä¸¤ä¸ªç‰ˆæœ¬ï¼ˆä¸€ä¸ªå®ï¼Œä¸€ä¸ªæ™®é€šå‡½æ•°ï¼‰
}
```

å¯ä»¥æŠŠ `constexpr` ç†è§£æˆï¼š**å¸¦æœ‰â€œç¼–è¯‘æœŸè®¡ç®—èƒ½åŠ›â€çš„æ™®é€šå‡½æ•°ã€‚**

ç¤ºä¾‹ 2ï¼šé…åˆæ•°ç»„é•¿åº¦ä½¿ç”¨

```cpp
constexpr int len() { return 5; }

int arr[len()];  // OKï¼Œlen() æ˜¯å¸¸é‡è¡¨è¾¾å¼
```

#### ä½¿ç”¨æ¡ä»¶ï¼ˆC++11/C++14ï¼‰

`constexpr` å‡½æ•°å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œæ‰èƒ½åœ¨ç¼–è¯‘æœŸæ±‚å€¼ï¼š

- **å‡½æ•°ä½“å¿…é¡»æ˜¯å¯è®¡ç®—çš„å¸¸é‡è¡¨è¾¾å¼**
- æ‰€æœ‰å‚æ•°ä¹Ÿå¿…é¡»æ˜¯å¸¸é‡ï¼ˆæ‰èƒ½å¯ç”¨ç¼–è¯‘æœŸæ±‚å€¼ï¼‰
- å‡½æ•°ä½“ä¸èƒ½æœ‰ï¼š
  - éå¸¸é‡å˜é‡å®šä¹‰ï¼ˆå¦‚ `int x = rand();`ï¼‰
  - è¿è¡ŒæœŸæ¡ä»¶åˆ¤æ–­æˆ–å¾ªç¯ï¼ˆC++14 èµ·éƒ¨åˆ†é™åˆ¶æ”¾å®½ï¼‰
- C++14 å¼€å§‹æ”¯æŒæ›´å¤æ‚çš„è¯­å¥ï¼Œå¦‚ `if`ã€`for`ã€é€’å½’ç­‰

#### ä¸ inline çš„å…³ç³»

- `constexpr` å‡½æ•°è‡ªåŠ¨éšå¼ä¸º `inline`ï¼Œæ‰€æœ‰ `constexpr` å‡½æ•°éƒ½ä¼š**è‡ªåŠ¨è§†ä¸º inline å‡½æ•°**ï¼Œè¿™æ ·å¯ä»¥**æ”¾å¿ƒåœ°åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å®ƒä»¬**ï¼Œ**åŒæ—¶æ”¯æŒç¼–è¯‘æœŸæ±‚å€¼ä¸å¤šæ–‡ä»¶åŒ…å«**ï¼Œé¿å…é“¾æ¥å†²çªã€‚
- ä½† `inline` å‡½æ•°å¹¶ä¸èƒ½ä¿è¯ç¼–è¯‘æœŸæ±‚å€¼ï¼Œå®ƒåªå½±å“**é“¾æ¥ä¸è°ƒç”¨æ–¹å¼**

#### ä¸ const å¯¹æ¯”

| ç‰¹æ€§       | `constexpr`  | `const`          |
| ---------- | ------------ | ---------------- |
| å®šä¹‰é˜¶æ®µ   | ç¼–è¯‘æœŸå¸¸é‡   | å¯ä»¥æ˜¯è¿è¡ŒæœŸå¸¸é‡ |
| ç”¨äºå‡½æ•°   | å¯ä»¥ç”¨äºå‡½æ•° | ä¸èƒ½ç”¨äºå‡½æ•°     |
| ç¼–è¯‘æœŸè®¡ç®— | æ”¯æŒ         | ä¸æ”¯æŒ           |
| å½±å“èŒƒå›´   | å€¼ & å‡½æ•°ä½“  | å€¼               |

### `constexpr` / `inline` å‡½æ•° vs å®ï¼ˆ`#define`ï¼‰

å®æ˜¯**ç®€å•çš„æ–‡æœ¬æ›¿æ¢**ï¼Œæ²¡æœ‰ç±»å‹æ£€æŸ¥ã€æ²¡æœ‰ä½œç”¨åŸŸæ§åˆ¶ã€å®¹æ˜“å‡ºé”™ï¼›è€Œ `inline` / `constexpr` å‡½æ•°æ˜¯**ç±»å‹å®‰å…¨ã€ä½œç”¨åŸŸæ˜ç¡®ã€æ”¯æŒè°ƒè¯•å’Œä¼˜åŒ–çš„ç°ä»£å†™æ³•**ï¼Œå‡ ä¹åœ¨æ‰€æœ‰åœºæ™¯ä¸‹éƒ½ä¼˜äºå®ã€‚

| ç‰¹æ€§/ç»´åº¦              | `#define` å®                   | `inline` / `constexpr` å‡½æ•°      |
| ---------------------- | ------------------------------ | -------------------------------- |
| ç¼–è¯‘é˜¶æ®µ               | **é¢„å¤„ç†å™¨é˜¶æ®µ**ï¼ˆå­—ç¬¦ä¸²æ›¿æ¢ï¼‰ | ç¼–è¯‘å™¨é˜¶æ®µï¼ˆè¯­ä¹‰å®Œæ•´ï¼Œç±»å‹æ£€æŸ¥ï¼‰ |
| æ˜¯å¦æœ‰ä½œç”¨åŸŸ           | âŒ æ²¡æœ‰ä½œç”¨åŸŸ                   | âœ… æœ‰ä½œç”¨åŸŸï¼Œåƒæ­£å¸¸å‡½æ•°ä¸€æ ·       |
| ç±»å‹æ£€æŸ¥               | âŒ æ²¡æœ‰ç±»å‹æ£€æŸ¥                 | âœ… æœ‰å®Œæ•´ç±»å‹æ£€æŸ¥                 |
| è°ƒè¯•æ”¯æŒ               | âŒ ä¸æ˜“è°ƒè¯•ï¼ˆæ— æ³•è®¾ç½®æ–­ç‚¹ï¼‰     | âœ… å¯è°ƒè¯•ï¼Œå¯å•æ­¥è¿›å…¥             |
| å¤šæ¬¡å®šä¹‰æ˜¯å¦æŠ¥é”™       | âŒ ä¸æŠ¥é”™ï¼Œä½†å¯èƒ½å‡ºç°å‰¯ä½œç”¨     | âœ… `inline`/`constexpr` å‡½æ•°åˆæ³•  |
| å‡½æ•°ç‰¹æ€§æ”¯æŒï¼ˆé€’å½’ç­‰ï¼‰ | âŒ ä¸æ”¯æŒ                       | âœ… `constexpr` å¯é€’å½’ï¼ˆC++14 èµ·ï¼‰ |
| å‘½åç©ºé—´æ”¯æŒ           | âŒ ä¸æ”¯æŒ                       | âœ… æ”¯æŒå‘½åç©ºé—´å’Œç±»ä½œç”¨åŸŸ         |
| æ˜¯å¦æœ‰å‰¯ä½œç”¨é£é™©       | âš ï¸ é«˜é£é™©ï¼šå‚æ•°å¯èƒ½é‡å¤æ±‚å€¼     | âœ… æ— å‰¯ä½œç”¨ï¼šå‚æ•°æ±‚å€¼ä¸€æ¬¡         |
| æ¨èç¨‹åº¦               | ğŸš« å°½é‡é¿å…                     | âœ… æ¨èä½¿ç”¨                       |

#### ç¤ºä¾‹1

å®ï¼šæœ‰å‰¯ä½œç”¨ã€æ— ç±»å‹æ£€æŸ¥

```cpp
#define SQUARE(x) ((x) * (x))

int a = SQUARE(5);     // OKï¼šç»“æœæ˜¯ 25
int b = SQUARE(1 + 2); // âš ï¸ ç»“æœæ˜¯ ((1 + 2) * (1 + 2)) = 9ï¼ˆæ­£ç¡®ï¼‰
int c = SQUARE(i++);   // âŒ æœ‰å‰¯ä½œç”¨ï¼i ä¼šè¢«è‡ªå¢ä¸¤æ¬¡
```

`constexpr` å‡½æ•°ï¼šå®‰å…¨ã€å¯è°ƒè¯•ã€å¯é€’å½’

```cpp
constexpr int square(int x) {
    return x * x;
}

int a = square(5);     // OKï¼šç»“æœæ˜¯ 25
int b = square(1 + 2); // OKï¼šç»“æœæ˜¯ 9
int c = square(i++);   // âœ… i++ åªæ‰§è¡Œä¸€æ¬¡ï¼ˆè™½ç„¶å¯èƒ½ä¸è¯¥è¿™æ ·å†™ï¼‰
```

#### ç¤ºä¾‹2

ç±»å‹æ£€æŸ¥é˜²é”™èƒ½åŠ›ï¼ˆå®æ²¡æœ‰ï¼‰

```cpp
#define MAX(x, y) ((x) > (y) ? (x) : (y))

constexpr int max(int x, int y) {
    return x > y ? x : y;
}

int x = MAX("hello", 5);  // âŒ ç¼–è¯‘ä¸æŠ¥é”™ï¼Œä½†è¿è¡Œå‡ºé”™
int y = max("hello", 5);  // âœ… ç¼–è¯‘æŠ¥é”™ï¼šç±»å‹ä¸å…¼å®¹
```

