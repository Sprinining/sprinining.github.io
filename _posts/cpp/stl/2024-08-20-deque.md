---
title: deque
date: 2024-08-20 03:09:01 +0800
categories: [cpp, stl]
tags: [CPP, CPP STL]
description: "deque 是双端动态数组容器，支持快速头尾插入删除，内存分段但逻辑上连续，适合频繁头尾操作场景。"
---
## deque

`deque` 是一个非常强大的容器，兼顾了随机访问和双端插删，适合做队列、缓存、滑动窗口等场景。底层结构比 `vector` 复杂，但性能更稳健，是 STL 容器中非常实用的一种。

### 基本特点

| 特性项   | 描述                                                                 |
| -------- | -------------------------------------------------------------------- |
| 全称     | Double Ended Queue（双端队列）                                       |
| 隶属     | STL 顺序容器之一                                                     |
| 存储结构 | **分段连续内存结构**（不像 `vector` 那样完全连续）                   |
| 支持操作 | **随机访问 + 头尾插入删除**，不适合中间插入                          |
| 默认底层 | 一般实现为**指针数组 + 块状内存区块**（典型 chunk size 为 512 字节） |
| 访问速度 | 访问中间元素略慢于 vector，但比 list 快                              |

### 底层原理图解

```css
逻辑视图：     [a0][a1][a2]...[an]
               ↑   ↑   ↑     ↑
            指向不同的内存块（元素连续）

内部结构：
- 一张“指针表”指向每一块内存
- 每块内存用于存储若干元素
- 逻辑顺序连续，但物理上非一整块
```

相比 `vector`：

| 特性     | `vector`         | `deque`                |
| -------- | ---------------- | ---------------------- |
| 内存布局 | 单块连续         | 分段连续               |
| 尾插效率 | 快               | 快                     |
| 头插效率 | 慢（要整体搬移） | 快（内部分配前段空间） |
| 随机访问 | O(1)             | O(1)（稍慢）           |
| 中间插删 | 慢               | 慢（要移动多个块内容） |

### 常见接口

```cpp
#include <deque>
using namespace std;

deque<int> dq;

// 基本操作
dq.push_back(1);
dq.push_front(2);
dq.pop_back();
dq.pop_front();

// 元素访问
dq[0];         // 支持随机访问
dq.at(1);      // 边界检查
dq.front();    // 访问头部
dq.back();     // 访问尾部

// 其他接口
dq.size();
dq.empty();
dq.clear();
dq.insert(dq.begin() + 1, 99);
dq.erase(dq.begin());
```

### 示例代码

```cpp
#include <deque>
#include <iostream>
using namespace std;

int main() {
    deque<int> dq = {1, 2, 3};
    dq.push_front(0);  // {0, 1, 2, 3}
    dq.push_back(4);   // {0, 1, 2, 3, 4}
    dq.pop_back();     // {0, 1, 2, 3}
    dq.pop_front();    // {1, 2, 3}

    for (int x : dq)
        cout << x << " ";  // 输出：1 2 3
}
```

### 和其他容器对比

| 操作     | `vector` | `deque`    | `list`             |
| -------- | -------- | ---------- | ------------------ |
| 尾部插入 | 快       | 快         | 快                 |
| 头部插入 | 慢       | 快         | 快                 |
| 中间插入 | 慢       | 慢         | 快（但无随机访问） |
| 随机访问 | 快       | 快（略慢） | 慢（无支持）       |

`deque` 是 vector 和 list 的中间态，平衡性能更适合做队列/缓存。

### 预留空间

容器预留空间，是为了避免频繁扩容时重新分配和移动数据。

- `vector`：**只在尾部预留空间**，所以头部插入效率很低，要整体移动数据。
- `deque`：**头部和尾部都能动态扩展**，而且提前预留了一些空间。

`deque` 内部不是一整块内存，而是 **多个连续大小的“内存块（chunk）”**，用一个**指针表**来管理：

```css
内部结构（简化）：
-------------------------------
[ chunk0 ][ chunk1 ][ chunk2 ]
   ↑         ↑         ↑
指针表：管理每个内存块的位置
```

当调用 `push_front()` 插入元素时：

- 如果 `chunk0` 前面还有空块，它直接用，不用移动元素。
- 如果没有，就再分配一个新的块插入到前面，更新指针表。

这就叫做**前端预留空间**：deque 会提前在头部保留一些块（或能扩容的空间），**让你能在前面 O(1) 插入**，而不像 vector 要搬整个数组。

### 使用建议场景

适合：

- 实现队列（`std::queue` 默认就用 `deque`）
- 频繁头尾插入删除
- 不希望扩容时复制整个内存（vs `vector`）

不适合：

- 中间频繁插入删除（不如 `list`）
- 元素地址不能变（如需要稳定指针）

### 注意事项

- `&dq[0]` 得到的内存不一定连续，**不能当数组用**
- 指向元素的指针/引用在插入头部/尾部时可能失效（尤其跨块）
- `insert` 在中间插入效率低（需搬动多个块内容）
- 适配器 `std::queue` 默认使用的是 `deque`，不是 `list`

